"""README.md ç”Ÿæˆå™¨"""
from ..templates.base import BaseTemplateGenerator


class ReadmeGenerator(BaseTemplateGenerator):
    """README.md æ–‡ä»¶ç”Ÿæˆå™¨"""
    
    def generate(self) -> None:
        """ç”Ÿæˆ README.md æ–‡ä»¶"""
        project_name = self.config_reader.get_project_name()
        
        content = self._build_header(project_name)
        content += self._build_features_section()
        content += self._build_installation_section()
        content += self._build_structure_section()
        content += self._build_configuration_section()
        content += self._build_api_docs_section()
        content += self._build_development_section()
        content += self._build_license_section()
        
        self.file_ops.create_markdown_file(
            file_path="README.md",
            title=None,
            content=content,
            overwrite=True
        )
    
    def _build_header(self, project_name: str) -> str:
        """æ„å»ºå¤´éƒ¨"""
        return f'''# {project_name}

FastAPI project generated by Forge.

'''
    
    def _build_features_section(self) -> str:
        """æ„å»ºåŠŸèƒ½åˆ—è¡¨éƒ¨åˆ†"""
        features = []
        
        if self.config_reader.has_database():
            db_type = self.config_reader.get_database_type()
            orm_type = self.config_reader.get_orm_type()
            features.append(f"- ğŸ—„ï¸ Database: {db_type} with {orm_type}")
        
        if self.config_reader.has_auth():
            auth_type = self.config_reader.get_auth_type()
            features.append(f"- ğŸ” Authentication: {auth_type}")
            if self.config_reader.has_refresh_token():
                features.append("- ğŸ”„ Refresh Token support")
        
        if self.config_reader.has_cors():
            features.append("- ğŸŒ CORS enabled")
        
        if self.config_reader.has_testing():
            features.append("- ğŸ§ª Testing with pytest")
        
        if self.config_reader.has_docker():
            features.append("- ğŸ³ Docker support")
        
        if self.config_reader.has_dev_tools():
            features.append("- ğŸ› ï¸ Development tools (Black, Ruff, MyPy)")
        
        return '## Features\n\n' + '\n'.join(features) + '\n\n'
    
    def _build_installation_section(self) -> str:
        """æ„å»ºå®‰è£…è¯´æ˜éƒ¨åˆ†"""
        return '''## Installation

### Using uv (Recommended)

```bash
# Install dependencies
uv sync

# Run the application
uv run uvicorn main:app --reload
```

### Using pip

```bash
# Create virtual environment
python -m venv .venv
source .venv/bin/activate  # On Windows: .venv\\Scripts\\activate

# Install dependencies
pip install -e .

# Run the application
uvicorn main:app --reload
```

'''
    
    def _build_structure_section(self) -> str:
        """æ„å»ºé¡¹ç›®ç»“æ„éƒ¨åˆ†"""
        content = '''## Project Structure

```
.
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/           # Core configurations
â”‚   â”œâ”€â”€ router/         # API routes
â”‚   â”œâ”€â”€ schemas/        # Pydantic schemas
â”‚   â”œâ”€â”€ utils/          # Utility functions
'''
        
        if self.config_reader.has_database():
            content += '''â”‚   â”œâ”€â”€ models/         # Database models
â”‚   â”œâ”€â”€ crud/           # CRUD operations
'''
        
        if self.config_reader.has_auth():
            content += '''â”‚   â”œâ”€â”€ services/       # Business logic
'''
        
        content += '''â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ main.py             # Application entry point
'''
        
        if self.config_reader.has_testing():
            content += '''â”œâ”€â”€ tests/              # Test files
'''
        
        content += '''â”œâ”€â”€ .env.example        # Environment variables example
â”œâ”€â”€ pyproject.toml      # Project dependencies
â””â”€â”€ README.md           # This file
```

'''
        return content
    
    def _build_configuration_section(self) -> str:
        """æ„å»ºé…ç½®è¯´æ˜éƒ¨åˆ†"""
        content = '''## Configuration

Copy `.env.example` to `.env` and update the values:

```bash
cp .env.example .env
```

'''
        
        if self.config_reader.has_database():
            content += self._build_database_config()
        
        return content
    
    def _build_database_config(self) -> str:
        """æ„å»ºæ•°æ®åº“é…ç½®è¯´æ˜"""
        content = '''### Database Configuration

Update the database connection string in `.env`:

```
DATABASE_URL=postgresql://user:password@localhost:5432/dbname
```

'''
        
        if self.config_reader.has_migration():
            content += '''### Database Migrations

```bash
# Create a new migration
alembic revision --autogenerate -m "description"

# Apply migrations
alembic upgrade head
```

'''
        
        return content
    
    def _build_api_docs_section(self) -> str:
        """æ„å»º API æ–‡æ¡£éƒ¨åˆ†"""
        return '''## API Documentation

Once the application is running, visit:

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

'''
    
    def _build_development_section(self) -> str:
        """æ„å»ºå¼€å‘è¯´æ˜éƒ¨åˆ†"""
        content = '## Development\n\n'
        
        if self.config_reader.has_dev_tools():
            content += self._build_dev_tools_section()
        
        if self.config_reader.has_testing():
            content += self._build_testing_section()
        
        if self.config_reader.has_docker():
            content += self._build_docker_section()
        
        return content
    
    def _build_dev_tools_section(self) -> str:
        """æ„å»ºå¼€å‘å·¥å…·è¯´æ˜"""
        return '''### Code Formatting

```bash
# Format code with Black
black .

# Lint with Ruff
ruff check .

# Type checking with MyPy
mypy .
```

'''
    
    def _build_testing_section(self) -> str:
        """æ„å»ºæµ‹è¯•è¯´æ˜"""
        return '''### Running Tests

```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=app tests/
```

'''
    
    def _build_docker_section(self) -> str:
        """æ„å»º Docker è¯´æ˜"""
        project_name = self.config_reader.get_project_name()
        return f'''### Docker

```bash
# Build image
docker build -t {project_name} .

# Run container
docker run -p 8000:8000 {project_name}
```

'''
    
    def _build_license_section(self) -> str:
        """æ„å»ºè®¸å¯è¯éƒ¨åˆ†"""
        return '''## License

MIT
'''
